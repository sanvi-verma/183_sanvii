# Jenkins inbound agent with JDK 17 + Maven 3.9.9
FROM jenkins/inbound-agent:jdk17

USER root

# ----- Configurable Maven version -----
ARG MAVEN_VERSION=3.9.9
ENV MAVEN_HOME=/opt/maven
ENV PATH=$PATH:$MAVEN_HOME/bin

# Install curl/tar and Maven (with archive fallback)
RUN apt-get update \
 && apt-get install -y curl tar \
 && set -eux; \
    TMP_TGZ=/tmp/maven.tgz; \
    URL_PRIMARY="https://downloads.apache.org/maven/maven-3/${MAVEN_VERSION}/binaries/apache-maven-${MAVEN_VERSION}-bin.tar.gz"; \
    URL_FALLBACK="https://archive.apache.org/dist/maven/maven-3/${MAVEN_VERSION}/binaries/apache-maven-${MAVEN_VERSION}-bin.tar.gz"; \
    (curl -fSL "$URL_PRIMARY"   -o "$TMP_TGZ" || curl -fSL "$URL_FALLBACK" -o "$TMP_TGZ"); \
    tar -xzf "$TMP_TGZ" -C /opt; \
    ln -s "/opt/apache-maven-${MAVEN_VERSION}" "$MAVEN_HOME"; \
    ln -s "$MAVEN_HOME/bin/mvn" /usr/local/bin/mvn; \
    rm -f "$TMP_TGZ" \
 && apt-get clean && rm -rf /var/lib/apt/lists/*

# Agent workdir must match the Jenkins node config
ENV AGENT_WORKDIR=/home/jenkins/agent
RUN mkdir -p "$AGENT_WORKDIR" && chown -R jenkins:jenkins /home/jenkins

USER jenkins
WORKDIR /home/jenkins/agent
